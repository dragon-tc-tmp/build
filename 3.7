#!/bin/bash
# Copyright (C) 2015 Joe Maples
#
# Licensed under the Apache License, Version 2.0 (the "License");
#   You may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

###########################################################################
###########################################################################
#####                                                                 #####
#####              B U I L D   C O N F I G U R A T I O N              #####
#####                                                                 #####
###########################################################################
###########################################################################

# Find Source Root
cd ../ && export TOOLCHAIN_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )";

# Make sure LLVM and friends are at the correct version, 3.7
cd $TOOLCHAIN_ROOT/llvm && git reset --hard && git fetch http://github.com/dragon-tc/llvm.git release_37 && git checkout FETCH_HEAD;
cd $TOOLCHAIN_ROOT/llvm/tools/clang && git reset --hard && git fetch http://llvm.org/git/clang.git release_37 && git checkout FETCH_HEAD;
cd $TOOLCHAIN_ROOT/llvm/tools/polly && git reset --hard && git fetch http://llvm.org/git/polly.git release_37 && git checkout FETCH_HEAD;
cd $TOOLCHAIN_ROOT/llvm/projects/compiler-rt && git reset --hard && git fetch http://llvm.org/git/compiler-rt.git release_37 && git checkout FETCH_HEAD;
cd $TOOLCHAIN_ROOT/llvm/projects/openmp && git reset --hard && git fetch http://llvm.org/git/openmp.git release_37 && git checkout FETCH_HEAD;

# Export Prefix Path
export PREFIX_PATH=$TOOLCHAIN_ROOT/out/3.7;

# Clean tree
if [ -d $TOOLCHAIN_ROOT/cmake ];
then
  $TOOLCHAIN_ROOT/build/common clean;
fi;

# Set OPT if requested
if [ $1 == "opt" ];
then
    export OPT="-march=native -mtune=native" 
fi;

# Build ISL if required
if ! [ -e $TOOLCHAIN_ROOT/out/isl.made ];
then
    $TOOLCHAIN_ROOT/build/common isl;
fi;

# Set flags for LLVM Compilation
export LOCAL_CXX_FLAGS="-O3 -Wno-macro-redefined -pipe $OPT"
export LOCAL_C_FLAGS="-O3 -Wno-macro-redefined -pipe $OPT"

# Compile Toolchain
$TOOLCHAIN_ROOT/build/common build;
